<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dashboard Layout</title>
    <link rel="stylesheet" href="./static/billing.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"/>
    <!-- Add Bootstrap CSS -->
      <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
      />
              <!-- Select2 CSS -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

        <!-- jQuery (required for Select2) -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <!-- Select2 JS -->
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


  </head>
  <body>
    <div class="whole-container">
      <div class="main-container">
        <div class="form-section">
          <div class="form-row">
            <label>Customer Name:</label>
            <input type="text" placeholder="Enter customer name" id="customerName"/>
          </div>
          <div class="form-row">
            <label for="salesmanName">Salesman Name:</label>
            <select id="salesmanName" name="salesmanName">
              <option value="">Select salesman</option>
              {% for name in salesmen %}
                <option value="{{ name }}">{{ name }}</option>
              {% endfor %}
            </select>

          </div>
          <div class="form-row">
            <label>Type of Invoice:</label>
            <input type="text" placeholder="Invoice type" id="invoice" />
            <label class="small-label">Session:</label>
            <input type="text" class="small-input" placeholder="Session" />
          </div>
          <div class="form-row">
            <label>Address:</label>
            <input type="text" placeholder="Enter address" id="address" />
            <label class="small-label">Online:</label>
            <input type="text" class="small-input" placeholder="Online" />
          </div>
          <div class="form-row">
            <label>Remark:</label>
            <input type="text" placeholder="Enter remark" />
          </div>
          <div class="form-row">
            <label>Quotation No:</label>
            <input type="text" placeholder="Enter quotation number" />
          </div>
        </div>

        <!-- Middle Form Section -->
        <div class="form-section1">
          <div class="form-row">
            <label>Invoice number:</label>
            <input type="text" placeholder="Enter invoice number" />
          </div>
          <div class="form-row">
            <label>Invoice Date:</label>
            <input type="date" />
          </div>
          <div class="form-row">
            <label>Time:</label>
            <input type="text" placeholder="Enter time" />
          </div>
          <div class="form-row">
            <label>User:</label>
            <input type="text" placeholder="Enter user" />
          </div>
         
          <div class="form-row">
            <label>Service No:</label>
            <input type="text" placeholder="Enter service number" />
          </div>
        </div>
        
        <div class="form-section3">
  
   <div class="form-group">
    <label for="priceOption">Price Type</label>
    <select id="priceOption" class="form-select">
      <option value="1">Retail Price</option>
      <option value="2">Wholesale Price</option>
      <option value="3">A Class Price</option>
      <option value="4">FOC</option>
      <option value="5">Branch</option>
    </select>
  </div>
     <div class="formsec">
          <div class="button-pair">
            <button class="button-pair1">P.Switch</button>
            <button class="button-pair1">Load</button>
          </div>
        </div>
        <div class="marquee-wrapper">
  <div class="marquee-text">DELIVERY CLOSING TIME:  </div>
</div>

  </div>
</div>

      
      <div class="table-design">
        <table>
          <thead>
            <tr class="table-header">
              <th style="width: 10%">Item Code</th>
              <th style="width: 25%">Item Description</th>
              <th style="width: 8%">Uom</th>
              <th style="width: 8%">Old</th>
              <th style="width: 10%">Rate</th>
              <th style="width: 8%">Qnty</th>
              <th style="width: 10%">Store</th>
              <th style="width: 10%">AM Dist%</th>
              <th style="width: 11%">Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr class="highlighted-row">
              <td><a href="itempage" ><input type="text" /></a></td>
              <td><input type="text" /></td>
              <td><input type="text" /></td>
              <td class="yellow-bg" style="background-color: yellow">
                <input type="text" />
              </td>
              <td class="green-bg" style="background-color: green">
                <input type="text" />
              </td>
              <td><input type="text" /></td>
              <td><input type="text" /></td>
              <td><input type="text" /></td>
              <td class="blue-bg" style="background-color: blue">
                <input type="text" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="scroll-area">
        <table>
          <thead>
            <tr>
              <th style="width: 8%">Item Code</th>
              <th style="width: 25%">Item Name</th>
              <th style="width: 8%">Barcode</th>
              <th style="width: 20%;">Store</th>
              <th style="width: 8%">Unit</th>
              <th style="width: 8%">Quantity</th>
              <th style="width: 8%;">Rate</th>
              <th style="width: 10%">AM Dist%</th>
              <th style="width: 11%">Amount</th>
            </tr>
          </thead>
          <tbody>
            <!-- Selected items will be dynamically added here -->
          </tbody>
        </table>
      </div>

      <div class="main-row">
        <div class="iconsDiv">
          <button><i class="fa-solid fa-plus"></i><br />New</button>
          <button>
            <i class="fa-solid fa-magnifying-glass"></i><br />Search
          </button>
          <button><i class="fa-solid fa-floppy-disk"></i><br />Save</button>
          <button><i class="fa-solid fa-print"></i><br />Print</button>
          <button><i class="fa-solid fa-id-card"></i><br />Card</button>
          <button><i class="fa-solid fa-pause-circle"></i><br />Hold</button>
          <button><i class="fa-solid fa-gift"></i><br />Redemption</button>
          <button>
            <i class="fa-solid fa-calendar-check"></i><br />Reserve
          </button>
          <button><i class="fa-solid fa-user"></i><br />Customer</button>
          <button><i class="fa-solid fa-users"></i><br /> Customers</button>
          <button><i class="fa-solid fa-list"></i><br />Item Lists</button>
          <button>
            <i class="fa-solid fa-file-invoice"></i><br />Bill Details
          </button>
          <button><i class="fa-solid fa-right-left"></i><br />P.Switch</button>
          <button id="refreshButton">
          <i class="fa-solid fa-arrow-rotate-right"></i><br />Refresh
          </button>

        </div>
        <div class="vertical">
          <div class="checkbox">
            <div class="check">
              <ul type="none">
                <li>
                  <input type="checkbox" class="c1" /><label for="check1"
                    >Auto Price</label
                  >
                </li>
                <li>
                  <input type="checkbox" class="c1" /><label for="check1"
                    >Details</label
                  >
                </li>
                <li>
                  <input type="checkbox" class="c1" /><label for="check1"
                    >Items Added</label
                  >
                </li>
                <li>
                  <input type="checkbox" class="c1" /><label for="check1"
                    >Old Price</label
                  >
                </li>
              </ul>
            </div>

            <div class="form-group">
              <div>
                <label for="input1">Total Points</label>  :000
                <!-- <input type="text" id="input1" readonly value="0"> -->
                <!-- <p style="text-align: end;"></p> -->
              </div>
              <div>
                <label for="input2">Privilege Points</label>  :000
                <!-- <input type="text" id="input2" readonly value="0"> -->
                <!-- <p style="text-align: end;"></p> -->
              </div>
            </div>
          </div>
          <table>
            <tr>
              <td><label>Amount:</label></td>
              <td>00</td>
            </tr>

            <tr>
              <td><label>Discount %:</label></td>
              <td>00</td>
            </tr>
            <tr>
              <td><label>Discount:</label></td>
              <td>00</td>
            </tr>
            <tr>
              <td><label>No Of products:</label></td>
              <td>00</td>
            </tr>
            <tr>
              <td><label>Amount:</label></td>
              <td>00</td>
            </tr>
            <tr>
              <td><label>Amount:</label></td>
              <td>00</td>
            </tr>
          </table>

          
        </div>
      </div>
      
    </div>
    <!-- Bootstrap Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="customerModalLabel">Select Customer</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
        <p>Here you can search or select a customer.</p>
<input type="text" id="customerSearch" class="form-control mb-2" placeholder="Search customer name or code...">

        <!-- Responsive Table Wrapper -->
        <div class="table-responsive">
          <table class="table table-bordered table-hover" id="customerTable">
            <thead class="table-light">
              <tr>
                             
                <th>CUST_CODE</th>
                <th>CUST_NAME</th>
                <th>ADDRESS</th>
                <th>CREDIT_LIMIT</th>
                <th>CREDIT_AMOUNT</th>
                <th>SALESMAN</th>
                <th>TYPE</th>
                <th>MOBILE</th>
            </tr>
      </thead>
      <tbody id="customerTableBody">
        
        <!-- Add more rows as needed -->
      </tbody>
    </table>
      </div>
      
    </div>
  </div>
</div>

    <!-- Add Bootstrap Bundle JS (with Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {

   
   

  const customerInput = document.getElementById('customerName');
  const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));
  const tableBody = document.getElementById('customerTableBody');
  const searchInput = document.getElementById('customerSearch');

  let allCustomers = [];

  // Open modal and fetch customers
  customerInput.addEventListener('click', function () {
    customerModal.show();

    if (allCustomers.length === 0) {
      fetch('customers')
        .then(response => response.json())
        .then(customers => {
          allCustomers = customers;
          renderCustomerTable(allCustomers);
        })
        .catch(err => {
          console.error('Error fetching customers:', err);
          tableBody.innerHTML = '<tr><td colspan="8">Error loading data.</td></tr>';
        });
    } else {
      renderCustomerTable(allCustomers); // use cached data
    }
  });

  
    // Load the selected customer from session storage
    const selectedCustomer = sessionStorage.getItem("selectedCustomer");
    if (selectedCustomer) {
        const customer = JSON.parse(selectedCustomer);
        console.log("Retrieved customer from session storage:", customer); // Log retrieved customer
        customerInput.value = customer.CUST_NAME; // Set customer name
        $('#salesmanName').val(customer.SALESMANNAME).trigger('change'); // Set salesman name
        document.getElementById('invoice').value = customer.TYPE; // Set invoice type
        document.getElementById('address').value = customer.ADDRESS; // Set address
    }
  // Live search inside modal input
  searchInput.addEventListener('input', function () {
    const searchTerm = this.value.toLowerCase();
    const filtered = allCustomers.filter(customer =>
      customer.CUST_NAME.toLowerCase().includes(searchTerm) ||
      customer.CUST_CODE.toLowerCase().includes(searchTerm)
    );
    renderCustomerTable(filtered);
  });

  // Function to render customer rows
 function renderCustomerTable(customers) {
   tableBody.innerHTML = '';

   if (!Array.isArray(customers) || customers.length === 0) {
     tableBody.innerHTML = '<tr><td colspan="8">No customers found.</td></tr>';
     return;
   }

   customers.forEach(customer => {
     const row = document.createElement('tr');
     row.innerHTML = `
        <td>${customer.CUST_CODE}</td>
        <td>${customer.CUST_NAME}</td>
        <td>${customer.ADDRESS}</td>
        <td>${customer.CREDIT_LIMIT}</td>
        <td>${customer.CREDIT_AMOUNT}</td>
        <td>${customer.SALESMANNAME}</td>
        <td>${customer.TYPE}</td>
        <td>${customer.MOBILE}</td>
      `;
      row.style.cursor = 'pointer';
      row.addEventListener('click', () => {
        // Store the selected customer in session storage
              sessionStorage.setItem("selectedCustomer", JSON.stringify(customer));
        document.getElementById('customerName').value = customer.CUST_NAME;
        $('#salesmanName').val(customer.SALESMANNAME).trigger('change');
        document.getElementById('invoice').value = customer.TYPE;
        document.getElementById('address').value = customer.ADDRESS;
        customerModal.hide();
      });
      tableBody.appendChild(row);
    });
  }
});


 
 
 
$("#customerSearch").on("input", function () {
    const searchValue = $(this).val();
    fetchCustomers(searchValue);
});

function fetchCustomers(searchTerm) {
    $.ajax({
        url: "/customers",
        method: "GET",
        data: { search: searchTerm },
        success: function (data) {
            let tableBody = $("#customerTableBody");
            tableBody.empty();

            if (data.length === 0) {
                tableBody.append("<tr><td colspan='8'>No results found</td></tr>");
                return;
            }

            data.forEach(function (customer) {
                let row = $(`
                    <tr style="cursor:pointer">
                        <td>${customer.CUST_CODE}</td>
                        <td>${customer.CUST_NAME}</td>
                        <td>${customer.ADDRESS}</td>
                        <td>${customer.CREDIT_LIMIT}</td>
                        <td>${customer.CREDIT_AMOUNT}</td>
                        <td>${customer.SALESMANNAME}</td>
                        <td>${customer.TYPE}</td>
                        <td>${customer.MOBILE}</td>
                    </tr>
                `);

                row.on("click", function () {
                    $("#customerName").val(customer.CUST_NAME);
                    $("#salesmanName").val(customer.SALESMANNAME).trigger('change');
                    $("#invoice").val(customer.TYPE);
                    $("#address").val(customer.ADDRESS);
                    bootstrap.Modal.getInstance(document.getElementById('customerModal')).hide();
                });

                tableBody.append(row);
            });
        },
        error: function (xhr, status, error) {
            console.error("Error:", error);
        }
    });
}



 document.addEventListener("DOMContentLoaded", function () {
    const tbody = document.querySelector(".scroll-area table tbody");
    let selectedItems = JSON.parse(sessionStorage.getItem("selectedItems") || "[]");

    function renderTable() {
        tbody.innerHTML = ""; // Clear existing rows

        if (selectedItems.length === 0) {
            tbody.innerHTML = "<tr><td colspan='9' style='text-align:center;'>No items selected</td></tr>";
        } else {
            selectedItems.forEach((item) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td><input type="text" class="item-code" value="${item.itemcode || ""}" /></td>
                    <td class="item-name">${item.itemname || ""}</td>
                    <td class="barcode">${item.barcode || ""}</td>
                    <td class="location">${item.locationname || ""}</td>
                    <td class="unit">
                        <select class="unit-select"></select>
                    </td>
                    <td class="quantity">${item.qty || ""}</td>
                    <td class="rate">${item.retailprice || ""}</td>
                    <td class="discount">${item.discount || ""}</td>
                    <td class="amount">${item.amount || ""}</td>
                `;
                const itemCodeInput = row.querySelector('.item-code');
                const unitSelect = row.querySelector('.unit-select');

                // Fetch available units for the item during initial load
                fetch(`/get_item_units?itemcode=${encodeURIComponent(item.itemcode)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Units not found');
                        }
                        return response.json();
                    })
                    .then(units => {
                        console.log('Fetched units:', units); // Log the units to check the response
                        // Clear existing options
                        unitSelect.innerHTML = "";
                        // Populate the select box with available units
                        units.forEach(unit => {
                            const option = document.createElement("option");
                            option.value = unit; // Assuming unit is a string
                            option.textContent = unit; // Display the unit
                            unitSelect.appendChild(option);
                        });

                        // Set the selected unit if it exists
                        if (item.unit) {
                            unitSelect.value = item.unit; // Set the current unit
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching item units:', error);
                    });

                // Add event listener for item code input
                itemCodeInput.addEventListener('change', function () {
                    const newItemCode = this.value;

                    // Fetch item details based on the new item code
                    fetch(`/search_items?itemcode=${encodeURIComponent(newItemCode)}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Item not found');
                            }
                            return response.json();
                        })
                        .then(items => {
                            if (items.length > 0) {
                                const itemDetails = items[0]; // Assuming you want the first match
                                // Update the row with the new item details
                                row.querySelector('.item-name').innerText = itemDetails.itemname || ""; // Item Name
                                row.querySelector('.barcode').innerText = itemDetails.barcode || ""; // Barcode
                                row.querySelector('.location').innerText = itemDetails.locationname || ""; // Store
                                row.querySelector('.quantity').innerText = itemDetails.qty || ""; // Quantity
                                row.querySelector('.rate').innerText = itemDetails.retailprice || ""; // Rate
                                row.querySelector('.discount').innerText = itemDetails.discount || ""; // AM Dist%
                                row.querySelector('.amount').innerText = itemDetails.amount || ""; // Amount

                                // Fetch available units for the new item
                                fetch(`/get_item_units?itemcode=${encodeURIComponent(newItemCode)}`)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Units not found');
                                        }
                                        return response.json();
                                    })
                                    .then(units => {
                                        // Clear existing options
                                        unitSelect.innerHTML = "";
                                        units.forEach(unit => {
                                            const option = document.createElement("option");
                                            option.value = unit; // Assuming unit is a string
                                            option.textContent = unit; // Display the unit
                                            unitSelect.appendChild(option);
                                        });

                                        // Set the selected unit if it exists
                                        if (itemDetails.unit) {
                                            unitSelect.value = itemDetails.unit; // Set the current unit
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error fetching item units:', error);
                                    });
                                    // Update the session storage with the new item
                                selectedItems = selectedItems.map(i => 
                                    i.itemcode === item.itemcode ? itemDetails : i
                                );
                                sessionStorage.setItem("selectedItems", JSON.stringify(selectedItems));
                            } else {
                                alert('No item found with that code.');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching item details:', error);
                            alert('Item not found. Please check the item code.');
                        });
                });
                // Add click event to toggle selection
                row.addEventListener("click", function() {
                    row.classList.toggle("selected"); // Toggle the selected class
                    const itemcode = item.itemcode; // Assuming itemcode is unique
                    if (selectedItems.some(i => i.itemcode === itemcode)) {
                        selectedItems = selectedItems.filter(i => i.itemcode !== itemcode); // Deselect
                    } else {
                        selectedItems.push(item); // Select
                    }
                    sessionStorage.setItem("selectedItems", JSON.stringify(selectedItems)); // Update sessionStorage
                });

                tbody.appendChild(row);
            });
        }
    }

    // Handle keyboard events for deletion
    document.addEventListener("keydown", function(event) {
        if (event.key === "Delete") {
            const rowsToDelete = Array.from(tbody.querySelectorAll("tr.selected"));
            rowsToDelete.forEach(row => {
                const itemcode = row.cells[0].querySelector('.item-code').value; // Get item code from input
                selectedItems = selectedItems.filter(item => item.itemcode !== itemcode); // Remove from selectedItems
                row.remove(); // Remove the row from the table
            });
            sessionStorage.setItem("selectedItems", JSON.stringify(selectedItems)); // Update sessionStorage
        }
    });

    // Initial render
    renderTable();

    // Add event listener for the refresh button
    document.getElementById("refreshButton").addEventListener("click", function () {
        console.log("Refresh button clicked");
        console.log("Before clearing, sessionStorage selectedItems:", sessionStorage.getItem("selectedItems"));
        console.log("Before clearing, sessionStorage selectedCustomer:", sessionStorage.getItem("selectedCustomer"));
        sessionStorage.removeItem("selectedItems");
        sessionStorage.removeItem("selectedCustomer");
        selectedItems = []; // Clear the local selectedItems array
        selectedCustomer=[];
        console.log("After clearing, sessionStorage selectedItems:", sessionStorage.getItem("selectedItems"));
        console.log("After clearing, sessionStorage selectedItems:", sessionStorage.getItem("selectedCustomer"));


        renderTable(); // Call renderTable to update the UI
    });
});


  </script>
  </body>
  </html>

